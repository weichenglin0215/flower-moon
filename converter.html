<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>詩詞資料轉換器 (Excel to JSON)</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            padding: 2rem;
            background: #f0f2f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }

        button {
            background: #c0392b;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background: #a93226;
        }

        pre {
            background: #2c3e50;
            color: #fff;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .instructions {
            background: #e8f8f5;
            padding: 1rem;
            border-left: 4px solid #1abc9c;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>詩詞資料轉換器</h1>

        <div class="instructions">
            <h3>如何使用：</h3>
            <ol>
                <li>打開您的 Excel 檔案。</li>
                <li>選取並複製包含資料的區域 (包括兩行一組的詩詞)。<br>
                    <strong>注意：</strong>請確保格式為：<br>
                    第一行：年代 | 類型 | 編號 | 作者 | 詩名 | 注音 | 總評 | 詩句1 | 詩句2...<br>
                    第二行：(空白) | (空白) | (空白) | (空白) | (空白) | (空白) | (空白) | 評分1 | 評分2...
                </li>
                <li>貼上到下方的文字框中。</li>
                <li>按下「轉換」按鈕。</li>
                <li>複製下方的結果，貼到 <code>data/poems.js</code> 中。</li>
            </ol>
        </div>

        <textarea id="inputArea" placeholder="在此貼上 Excel 資料..."></textarea>
        <button onclick="convert()">轉換成程式碼格式</button>

        <h3>轉換結果：</h3>
        <pre id="outputArea">// 等待輸入...</pre>
    </div>

    <script>
        function convert() {
            const input = document.getElementById('inputArea').value;
            // Use custom TSV parser to handle quotes and newlines within cells
            const lines = parseTSV(input);
            const poems = [];

            // Excel copy-paste is tab-separated
            for (let i = 0; i < lines.length; i++) {
                const row = lines[i]; // This is already an array of cells

                // Skip empty lines
                // Format:
                // Row 1: Dynasty(0) | Type(1) | ID(2) | Author(3) | Title(4) | Zhuyin(5) | Rating(6) | Content(7)...
                // Row 2: Empty......                                                           | Ratings(7)...

                // Heuristic: Check if this row has metadata (columns 0-3 are not empty)
                if (!row[0] && !row[3]) continue; 

                const poem = {
                    id: parseInt(row[2]) || Date.now(), 
                    dynasty: row[0],
                    type: row[1],
                    author: row[3],
                    title: row[4] || '',
                    zhuyin: row[5] || '', // Parser already handles quotes
                    rating: parseInt(row[6]) || 0, // Column 6 is Rating (Total Review Score)
                    content: [],
                    line_ratings: [],
                    tags: [] 
                };

                // Prepare to read ratings from next row if available
                let nextRow = null;
                if (i + 1 < lines.length) {
                    const candidate = lines[i + 1];
                    // Verify if this is indeed a rating row (Metadata columns should be empty)
                    // We check a few columns to be sure
                    if (!candidate[0] && !candidate[3] && !candidate[4]) {
                        nextRow = candidate;
                        i++; // Advance main loop index as we consumed this row
                    }
                }

                // Extract poem lines AND ratings simultaneously to ensure alignment
                // We iterate through columns starting from 7
                for (let j = 7; j < row.length; j++) {
                    if (row[j]) { // Only handle if there is actual content
                        poem.content.push(row[j]);

                        // Extract corresponding rating
                        let rate = 0;
                        if (nextRow && nextRow[j]) {
                            rate = parseInt(nextRow[j]);
                            if (isNaN(rate)) rate = 0;
                        }
                        poem.line_ratings.push(rate);
                    }
                }

                poems.push(poem);
            }

            const jsonString = JSON.stringify(poems, null, 2);
            // Wrap in variable for simple JS file usage
            const output = `const POEMS = ${jsonString};`;

            document.getElementById('outputArea').textContent = output;
        }

        // Custom TSV Parser to handle Excel pasted data
        function parseTSV(input) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuote = false;
            
            // Normalize line endings to \n
            input = input.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let i = 0; i < input.length; i++) {
                const char = input[i];
                const nextChar = input[i + 1];
                
                if (inQuote) {
                    if (char === '"') {
                        if (nextChar === '"') {
                            // Escaped quote ("") -> quote (")
                            currentCell += '"';
                            i++;
                        } else {
                            // End of quote
                            inQuote = false;
                        }
                    } else {
                        currentCell += char;
                    }
                } else {
                    if (char === '"') {
                        inQuote = true;
                    } else if (char === '\t') {
                        currentRow.push(currentCell);
                        currentCell = '';
                    } else if (char === '\n') {
                        currentRow.push(currentCell);
                        rows.push(currentRow);
                        currentRow = [];
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
            }
            // Handle last cell/row if not empty
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                rows.push(currentRow);
            }
            return rows;
        }
    </script>
</body>

</html>